<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyPals - Spotify Integration</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            line-height: 1.6;
        }

        .min-h-screen {
            min-height: 100vh;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .space-x-2 > * + * {
            margin-left: 0.5rem;
        }

        .space-x-3 > * + * {
            margin-left: 0.75rem;
        }

        .space-x-4 > * + * {
            margin-left: 1rem;
        }

        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .grid {
            display: grid;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .lg\\:grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .lg\\:col-span-1 {
            grid-column: span 1 / span 1;
        }

        .lg\\:col-span-2 {
            grid-column: span 2 / span 2;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .max-w-md {
            max-width: 28rem;
        }

        .max-w-6xl {
            max-width: 72rem;
        }

        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }

        .p-3 {
            padding: 0.75rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .py-12 {
            padding-top: 3rem;
            padding-bottom: 3rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-3 {
            margin-bottom: 0.75rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mb-6 {
            margin-bottom: 1.5rem;
        }

        .w-4 {
            width: 1rem;
        }

        .w-6 {
            width: 1.5rem;
        }

        .w-12 {
            width: 3rem;
        }

        .w-16 {
            width: 4rem;
        }

        .h-4 {
            height: 1rem;
        }

        .h-6 {
            height: 1.5rem;
        }

        .h-12 {
            height: 3rem;
        }

        .h-16 {
            height: 4rem;
        }

        .max-h-96 {
            max-height: 24rem;
        }

        .overflow-y-auto {
            overflow-y: auto;
        }

        .rounded {
            border-radius: 0.25rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .rounded-full {
            border-radius: 9999px;
        }

        .border {
            border-width: 1px;
        }

        .border-b {
            border-bottom-width: 1px;
        }

        .border-green-200 {
            border-color: #bbf7d0;
        }

        .border-red-200 {
            border-color: #fecaca;
        }

        .bg-white {
            background-color: #ffffff;
        }

        .bg-gray-50 {
            background-color: #f9fafb;
        }

        .bg-green-50 {
            background-color: #f0fdf4;
        }

        .bg-red-50 {
            background-color: #fef2f2;
        }

        .bg-green-600 {
            background-color: #16a34a;
        }

        .bg-gray-100 {
            background-color: #f3f4f6;
        }

        .text-white {
            color: #ffffff;
        }

        .text-gray-400 {
            color: #9ca3af;
        }

        .text-gray-500 {
            color: #6b7280;
        }

        .text-gray-600 {
            color: #4b5563;
        }

        .text-gray-900 {
            color: #111827;
        }

        .text-green-600 {
            color: #16a34a;
        }

        .text-red-600 {
            color: #dc2626;
        }

        .text-red-700 {
            color: #b91c1c;
        }

        .text-red-800 {
            color: #991b1b;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-md {
            font-size: 1rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .text-xl {
            font-size: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .object-cover {
            object-fit: cover;
        }

        .flex-1 {
            flex: 1 1 0%;
        }

        .min-w-0 {
            min-width: 0px;
        }

        .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .transition-colors {
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .hover\\:bg-gray-50:hover {
            background-color: #f9fafb;
        }

        .hover\\:bg-gray-100:hover {
            background-color: #f3f4f6;
        }

        .hover\\:bg-green-700:hover {
            background-color: #15803d;
        }

        .hover\\:text-red-700:hover {
            color: #b91c1c;
        }

        .focus\\:ring-2:focus {
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
        }

        .focus\\:ring-green-500:focus {
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
        }

        .focus\\:border-transparent:focus {
            border-color: transparent;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Custom Styles */
        .spotify-card {
            background: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(29, 185, 84, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .spotify-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(29, 185, 84, 0.4);
        }

        .connect-btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .connect-btn:hover {
            background: #1ed760;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.4);
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .track-item:hover {
            background-color: #f3f4f6;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .playlist-item:hover {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .playlist-item.selected {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .search-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #1DB954;
            box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
        }

        .search-btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .search-btn:hover {
            background: #1ed760;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1DB954;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .lg\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .lg\\:col-span-1,
            .lg\\:col-span-2 {
                grid-column: span 1;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .max-w-6xl {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading-screen" class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loading-spinner" style="width: 48px; height: 48px; border-width: 4px;"></div>
                <p class="text-gray-600 mt-4">Loading StudyPals Spotify Integration...</p>
            </div>
        </div>

        <!-- Main App Content -->
        <div id="main-content" style="display: none;">
            <!-- Header -->
            <div class="bg-white shadow-sm border-b">
                <div class="max-w-6xl mx-auto px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center">
                                <span style="font-size: 24px;">üéµ</span>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900">StudyPals - Spotify Integration</h1>
                                <p class="text-gray-600">Connect and manage your Spotify music</p>
                            </div>
                        </div>
                        <button id="disconnect-btn" class="text-red-600 hover:text-red-700 text-sm font-medium" style="display: none;">
                            Disconnect
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="max-w-6xl mx-auto p-6">
                <!-- Connection Status -->
                <div id="connection-status" class="spotify-card mb-6">
                    <h2 class="text-xl font-semibold mb-2">üéµ Connect to Spotify</h2>
                    <p class="mb-4">Connect your Spotify account to access your playlists, search music, and manage your library.</p>
                    <button id="connect-spotify" class="connect-btn">
                        Connect Spotify Account
                    </button>
                </div>

                <!-- Error/Success Messages -->
                <div id="message-container"></div>

                <!-- Dashboard Content (Hidden initially) -->
                <div id="dashboard-content" style="display: none;">
                    <!-- User Info -->
                    <div id="user-info" class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Welcome back!</h2>
                        <div id="user-details"></div>
                    </div>

                    <!-- Search Section -->
                    <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Search Music</h2>
                        <div class="search-container">
                            <input 
                                type="text" 
                                id="search-input"
                                class="search-input"
                                placeholder="Search for songs, artists, or albums..."
                            />
                            <button id="search-btn" class="search-btn">
                                üîç Search
                            </button>
                        </div>
                        <div id="search-results"></div>
                    </div>

                    <!-- Main Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Playlists -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-lg shadow-sm border p-6">
                                <h2 class="text-lg font-semibold text-gray-900 mb-4">Your Playlists</h2>
                                <div id="playlists-container" class="max-h-96 overflow-y-auto">
                                    <div class="text-center py-8">
                                        <div class="loading-spinner mx-auto mb-4"></div>
                                        <p class="text-gray-600">Loading playlists...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tracks -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-lg shadow-sm border p-6">
                                <h2 id="tracks-title" class="text-lg font-semibold text-gray-900 mb-4">Select a playlist</h2>
                                <div id="tracks-container" class="max-h-96 overflow-y-auto">
                                    <div class="text-center py-12">
                                        <span style="font-size: 48px;">üéµ</span>
                                        <p class="text-gray-600 mt-4">Select a playlist to view tracks</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * StudyPals Spotify Integration - Complete Frontend
         * 
         * This is a consolidated HTML file containing all the functionality
         * needed for Spotify integration in the StudyPals application.
         * 
         * Features:
         * - OAuth authentication with Spotify
         * - User profile display
         * - Playlist management
         * - Track search and playback
         * - Responsive design
         * 
         * @author StudyPals Team
         * @version 1.0.0
         */

        // Configuration
        const CONFIG = {
            SPOTIFY_CLIENT_ID: '6840c4bc3c11466a81c2822ca3cd1f2e',
            REDIRECT_URI: 'http://127.0.0.1:3000/auth/spotify/callback',
            SCOPES: [
                'user-read-private',
                'user-read-email',
                'playlist-read-private',
                'playlist-read-collaborative',
                'playlist-modify-public',
                'playlist-modify-private',
                'user-library-read',
                'user-library-modify'
            ],
            API_BASE_URL: 'https://api.spotify.com/v1',
            BACKEND_URL: 'http://localhost:5000'
        };

        // State Management
        let currentUser = null;
        let playlists = [];
        let currentPlaylist = null;
        let tracks = [];
        let searchResults = [];
        let accessToken = null;

        // DOM Elements
        const elements = {
            loadingScreen: document.getElementById('loading-screen'),
            mainContent: document.getElementById('main-content'),
            connectionStatus: document.getElementById('connection-status'),
            dashboardContent: document.getElementById('dashboard-content'),
            connectBtn: document.getElementById('connect-spotify'),
            disconnectBtn: document.getElementById('disconnect-btn'),
            messageContainer: document.getElementById('message-container'),
            userInfo: document.getElementById('user-info'),
            userDetails: document.getElementById('user-details'),
            searchInput: document.getElementById('search-input'),
            searchBtn: document.getElementById('search-btn'),
            searchResults: document.getElementById('search-results'),
            playlistsContainer: document.getElementById('playlists-container'),
            tracksContainer: document.getElementById('tracks-container'),
            tracksTitle: document.getElementById('tracks-title')
        };

        /**
         * Utility Functions
         */

        /**
         * Displays a temporary message to the user
         * @param {string} message - The message to display
         * @param {('error'|'success')} type - The type of message
         */
        function showMessage(message, type = 'error') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            elements.messageContainer.innerHTML = '';
            elements.messageContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        /**
         * Generates a secure random state parameter for OAuth
         * @returns {string} A random string for OAuth state verification
         */
        function generateState() {
            const array = new Uint32Array(8);
            window.crypto.getRandomValues(array);
            return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
        }

        /**
         * Authentication Functions
         */

        /**
         * Initiates the Spotify OAuth connection flow
         * Redirects the user to Spotify's authorization page
         */
        function connectToSpotify() {
            const state = generateState();
            sessionStorage.setItem('spotify_oauth_state', state);
            
            const params = new URLSearchParams({
                client_id: CONFIG.SPOTIFY_CLIENT_ID,
                redirect_uri: CONFIG.REDIRECT_URI,
                scope: CONFIG.SCOPES.join(' '),
                response_type: 'code',
                state: state
            });
            
            const authUrl = `https://accounts.spotify.com/authorize?${params.toString()}`;
            window.location.href = authUrl;
        }

        /**
         * Handles the OAuth callback from Spotify
         * Validates the state parameter and exchanges the auth code for tokens
         * @throws {Error} If authentication fails or state is invalid
         */
        function handleAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            if (error) {
                showMessage(`Authentication failed: ${error}`, 'error');
                return;
            }
            
            if (code && state) {
                const storedState = sessionStorage.getItem('spotify_oauth_state');
                if (state !== storedState) {
                    showMessage('Invalid state parameter', 'error');
                    return;
                }
                
                sessionStorage.removeItem('spotify_oauth_state');
                exchangeCodeForTokens(code);
            }
        }

        /**
         * Exchanges the OAuth authorization code for access and refresh tokens
         * Stores the tokens in localStorage and updates the app state
         * @param {string} code - The authorization code from Spotify
         * @returns {Promise<void>}
         * @throws {Error} If token exchange fails
         */
        async function exchangeCodeForTokens(code) {
            try {
                showMessage('Connecting to Spotify...', 'success');
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/api/auth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'spotify',
                        code: code,
                        clientId: CONFIG.SPOTIFY_CLIENT_ID,
                        redirectUri: CONFIG.REDIRECT_URI
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to exchange code for tokens');
                }
                
                const tokens = await response.json();
                accessToken = tokens.accessToken;
                
                // Store tokens in localStorage
                localStorage.setItem('spotify_access_token', tokens.accessToken);
                localStorage.setItem('spotify_refresh_token', tokens.refreshToken);
                localStorage.setItem('spotify_expires_at', tokens.expiresAt);
                
                showMessage('Successfully connected to Spotify!', 'success');
                await loadUserData();
                
            } catch (error) {
                console.error('Token exchange error:', error);
                showMessage('Failed to connect to Spotify. Please try again.', 'error');
            }
        }

        function disconnectFromSpotify() {
            if (confirm('Are you sure you want to disconnect from Spotify?')) {
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_refresh_token');
                localStorage.removeItem('spotify_expires_at');
                
                accessToken = null;
                currentUser = null;
                playlists = [];
                tracks = [];
                searchResults = [];
                
                showConnectionScreen();
                showMessage('Disconnected from Spotify', 'success');
            }
        }

        /**
         * API Functions
         */

        /**
         * Makes an authenticated request to the Spotify API
         * Handles token refresh if the current token is expired
         * @param {string} endpoint - The Spotify API endpoint to call
         * @param {Object} options - Additional fetch options
         * @returns {Promise<Object>} The JSON response from the API
         * @throws {Error} If the request fails or authentication is invalid
         */
        /**
         * Makes an authenticated request to the Spotify API with improved error handling
         * @param {string} endpoint - The API endpoint to call
         * @param {Object} options - Request options
         * @returns {Promise<Object>} The API response
         * @throws {Error} With detailed error information
         */
        async function makeSpotifyRequest(endpoint, options = {}) {
            if (!accessToken) {
                throw new Error('Not authenticated with Spotify. Please connect your account.');
            }
            
            // Add retry logic for network issues
            let attempts = 0;
            const maxAttempts = 3;
            
            const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            if (response.status === 401) {
                // Token expired, try to refresh
                await refreshAccessToken();
                return makeSpotifyRequest(endpoint, options);
            }
            
            if (!response.ok) {
                throw new Error(`Spotify API error: ${response.status}`);
            }
            
            return response.json();
        }

        /**
         * Refreshes the Spotify access token using the stored refresh token
         * Updates localStorage with the new access token
         * @returns {Promise<void>}
         * @throws {Error} If refresh fails or no refresh token is available
         */
        /**
         * Refreshes the access token with improved error handling and retry logic
         * @returns {Promise<void>}
         * @throws {Error} If token refresh fails after retries
         */
        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            if (!refreshToken) {
                localStorage.clear(); // Clear all auth data if refresh token is missing
                throw new Error('No refresh token available. Please reconnect to Spotify.');
            }
            
            let attempts = 0;
            const maxAttempts = 3;
            
            const response = await fetch(`${CONFIG.BACKEND_URL}/api/auth/refresh`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    provider: 'spotify',
                    refreshToken: refreshToken
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to refresh token');
            }
            
            const tokens = await response.json();
            accessToken = tokens.accessToken;
            localStorage.setItem('spotify_access_token', tokens.accessToken);
            localStorage.setItem('spotify_expires_at', tokens.expiresAt);
        }

        /**
         * Loads the current user's Spotify profile data
         * Updates the currentUser state and loads playlists
         * @returns {Promise<void>}
         * @throws {Error} If user data cannot be fetched
         */
        async function loadUserData() {
            try {
                const userData = await makeSpotifyRequest('/me');
                currentUser = {
                    id: userData.id,
                    name: userData.display_name,
                    email: userData.email,
                    imageUrl: userData.images?.[0]?.url
                };
                
                await loadPlaylists();
                showDashboard();
                
            } catch (error) {
                console.error('Failed to load user data:', error);
                showMessage('Failed to load user data', 'error');
            }
        }

        /**
         * Loads the user's Spotify playlists
         * Updates the playlists state and renders the playlist list
         * @returns {Promise<void>}
         * @throws {Error} If playlists cannot be fetched
         */
        async function loadPlaylists() {
            try {
                const data = await makeSpotifyRequest('/me/playlists');
                playlists = data.items.map(playlist => ({
                    id: playlist.id,
                    name: playlist.name,
                    description: playlist.description,
                    imageUrl: playlist.images?.[0]?.url,
                    trackCount: playlist.tracks.total,
                    externalUrl: playlist.external_urls.spotify
                }));
                
                renderPlaylists();
                
            } catch (error) {
                console.error('Failed to load playlists:', error);
                showMessage('Failed to load playlists', 'error');
            }
        }

        /**
         * Loads the tracks for a specific playlist
         * Updates the tracks state and renders the track list
         * @param {string} playlistId - The Spotify ID of the playlist
         * @returns {Promise<void>}
         * @throws {Error} If tracks cannot be fetched
         */
        async function loadPlaylistTracks(playlistId) {
            try {
                const data = await makeSpotifyRequest(`/playlists/${playlistId}/tracks`);
                tracks = data.items.map(item => ({
                    id: item.track.id,
                    name: item.track.name,
                    artist: item.track.artists[0].name,
                    album: item.track.album.name,
                    duration: item.track.duration_ms,
                    imageUrl: item.track.album.images?.[0]?.url,
                    previewUrl: item.track.preview_url,
                    externalUrl: item.track.external_urls.spotify
                }));
                
                renderTracks();
                
            } catch (error) {
                console.error('Failed to load playlist tracks:', error);
                showMessage('Failed to load playlist tracks', 'error');
            }
        }

        /**
         * Searches for tracks on Spotify
         * Updates the searchResults state and renders the results
         * @param {string} query - The search query
         * @returns {Promise<void>}
         * @throws {Error} If search fails
         */
        async function searchTracks(query) {
            try {
                const data = await makeSpotifyRequest(`/search?q=${encodeURIComponent(query)}&type=track&limit=10`);
                searchResults = data.tracks.items.map(track => ({
                    id: track.id,
                    name: track.name,
                    artist: track.artists[0].name,
                    album: track.album.name,
                    duration: track.duration_ms,
                    imageUrl: track.album.images?.[0]?.url,
                    previewUrl: track.preview_url,
                    externalUrl: track.external_urls.spotify
                }));
                
                renderSearchResults();
                
            } catch (error) {
                console.error('Search failed:', error);
                showMessage('Search failed', 'error');
            }
        }

        /**
         * Rendering Functions
         */

        /**
         * Shows the initial connection screen
         * Hides the dashboard and disconnect button
         */
        function showConnectionScreen() {
            elements.connectionStatus.style.display = 'block';
            elements.dashboardContent.style.display = 'none';
            elements.disconnectBtn.style.display = 'none';
        }

        function showDashboard() {
            elements.connectionStatus.style.display = 'none';
            elements.dashboardContent.style.display = 'block';
            elements.disconnectBtn.style.display = 'block';
            
            renderUserInfo();
        }

        /**
         * Renders the user's profile information
         * Displays user's name, email, and profile picture if available
         */
        function renderUserInfo() {
            if (currentUser) {
                elements.userDetails.innerHTML = `
                    <div class="flex items-center space-x-4">
                        ${currentUser.imageUrl ? 
                            `<img src="${currentUser.imageUrl}" alt="${currentUser.name}" class="w-16 h-16 rounded-full object-cover">` :
                            `<div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center">
                                <span style="font-size: 24px;">üë§</span>
                            </div>`
                        }
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${currentUser.name}</h3>
                            ${currentUser.email ? `<p class="text-gray-600">${currentUser.email}</p>` : ''}
                        </div>
                    </div>
                `;
            }
        }

        /**
         * Renders the user's playlists
         * Displays playlist cover art, name, and track count
         * Shows a message if no playlists are found
         */
        function renderPlaylists() {
            if (playlists.length === 0) {
                elements.playlistsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <span style="font-size: 48px;">üìù</span>
                        <p class="text-gray-600 mt-4">No playlists found</p>
                    </div>
                `;
                return;
            }
            
            elements.playlistsContainer.innerHTML = playlists.map(playlist => `
                <div class="playlist-item" onclick="selectPlaylist('${playlist.id}')">
                    <img 
                        src="${playlist.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAyNEMyNCAyNCAyNCAyNCAyNCAyNEMyNCAyNCAyNCAyNCAyNCAyNFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'}" 
                        alt="${playlist.name}" 
                        class="w-12 h-12 rounded object-cover"
                    />
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900 truncate">${playlist.name}</p>
                        <p class="text-sm text-gray-600">${playlist.trackCount} tracks</p>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Handles playlist selection
         * Updates the current playlist and loads its tracks
         * @param {string} playlistId - The Spotify ID of the selected playlist
         */
        function selectPlaylist(playlistId) {
            currentPlaylist = playlists.find(p => p.id === playlistId);
            elements.tracksTitle.textContent = currentPlaylist.name;
            loadPlaylistTracks(playlistId);
            
            // Update selected state
            document.querySelectorAll('.playlist-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        function renderTracks() {
            if (tracks.length === 0) {
                elements.tracksContainer.innerHTML = `
                    <div class="text-center py-8">
                        <span style="font-size: 48px;">üéµ</span>
                        <p class="text-gray-600 mt-4">No tracks in this playlist</p>
                    </div>
                `;
                return;
            }
            
            elements.tracksContainer.innerHTML = tracks.map(track => `
                <div class="track-item">
                    <img 
                        src="${track.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAyNEMyNCAyNCAyNCAyNCAyNCAyNEMyNCAyNCAyNCAyNCAyNCAyNFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'}" 
                        alt="${track.album}" 
                        class="w-12 h-12 rounded object-cover"
                    />
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900 truncate">${track.name}</p>
                        <p class="text-sm text-gray-600 truncate">${track.artist}</p>
                    </div>
                    <div class="text-sm text-gray-500">
                        ${formatDuration(track.duration)}
                    </div>
                    <button class="p-2 hover:bg-gray-100 rounded-full" onclick="playTrack('${track.id}')">
                        ‚ñ∂Ô∏è
                    </button>
                </div>
            `).join('');
        }

        function renderSearchResults() {
            if (searchResults.length === 0) {
                elements.searchResults.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-600">No results found</p>
                    </div>
                `;
                return;
            }
            
            elements.searchResults.innerHTML = `
                <div class="mt-6">
                    <h3 class="text-md font-medium text-gray-900 mb-3">Search Results</h3>
                    <div class="space-y-2">
                        ${searchResults.map(track => `
                            <div class="track-item">
                                <img 
                                    src="${track.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAyNEMyNCAyNCAyNCAyNCAyNCAyNEMyNCAyNCAyNCAyNCAyNCAyNFoiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'}" 
                                    alt="${track.album}" 
                                    class="w-12 h-12 rounded object-cover"
                                />
                                <div class="flex-1">
                                    <p class="font-medium text-gray-900">${track.name}</p>
                                    <p class="text-sm text-gray-600">${track.artist}</p>
                                </div>
                                <div class="text-sm text-gray-500">
                                    ${formatDuration(track.duration)}
                                </div>
                                <button class="p-2 hover:bg-gray-100 rounded-full" onclick="playTrack('${track.id}')">
                                    ‚ñ∂Ô∏è
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        /**
         * Attempts to play a track preview
         * Note: This is a simplified implementation. In production,
         * you would use Spotify's Web Playback SDK
         * @param {string} trackId - The Spotify ID of the track to play
         */
        function playTrack(trackId) {
            const track = [...tracks, ...searchResults].find(t => t.id === trackId);
            if (track && track.previewUrl) {
                // In a real implementation, you'd use Spotify's Web Playback SDK
                showMessage(`Playing: ${track.name} by ${track.artist}`, 'success');
            } else {
                showMessage('Preview not available for this track', 'error');
            }
        }

        // Event Listeners
        elements.connectBtn.addEventListener('click', connectToSpotify);
        elements.disconnectBtn.addEventListener('click', disconnectFromSpotify);
        elements.searchBtn.addEventListener('click', () => {
            const query = elements.searchInput.value.trim();
            if (query) {
                searchTracks(query);
            }
        });
        elements.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = elements.searchInput.value.trim();
                if (query) {
                    searchTracks(query);
                }
            }
        });

        // Initialize App
        function initializeApp() {
            // Check if we're returning from OAuth callback
            if (window.location.pathname.includes('/auth/spotify/callback')) {
                handleAuthCallback();
                return;
            }
            
            // Check for existing authentication
            const storedToken = localStorage.getItem('spotify_access_token');
            const expiresAt = localStorage.getItem('spotify_expires_at');
            
            if (storedToken && expiresAt && Date.now() < parseInt(expiresAt)) {
                accessToken = storedToken;
                loadUserData();
            } else {
                showConnectionScreen();
            }
            
            // Hide loading screen
            elements.loadingScreen.style.display = 'none';
            elements.mainContent.style.display = 'block';
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
